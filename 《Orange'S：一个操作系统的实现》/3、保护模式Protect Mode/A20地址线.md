# A20地址线

学习linux0.11源代码中的boot启动部分代码时会看到打开A20地址线的操作，这A20地址线到底是何方神圣？

这就要从Intel8086说起了。8086是16位的，有16根数据线，寄存器也是16位的，但是有20根地址线。Intel设计了一种分段寻址模式：16位的段基址:16位偏移地址，从而提供了1M的寻址能力。

当程序给出超过1M地址的时候会怎么样呢？CPU并不会报错，而是采用了wrap-around模式（回卷），也就是重新从0地址开始寻址。而那时候有很多程序利用了这种回卷的特性。

从Intel80286的cpu地址总线增加到24跟，当程序给出超出1M地址的时候会寻址到实际的内存地址。这就无法向前兼容，以前那些利用回卷特性编写的程序就无法再80286上愉快的玩耍了。为了解决这个问题，IBM想到了一个办法，我们关闭20位以上的地址线不就跟以前一样了吗？（关闭的地址线总是返回0）。具体实现是使用8042键盘控制器来控制第20个地址位（从0开始，其实是第21位地址线，也称A20 Gate），具体什么原理我就不太懂了，反正代码里就是使用in/out指令就可以实现。

IBM的这种Hack方法并不是唯一的控制20地址线的方法，但是大部分时候是适用的，采用率很高。

问题又来了，关闭之后不就无法寻址到1M以上空间了吗？那进入保护时候之后4G的寻址能力不就白瞎了吗？对，这就是linux0.11的启动代码在进入保护模式事前都必须打开A20地址线，才能保证进入保护模式具有4G的寻址能力。

那启动之前A20地址线都是关闭的？是的，大部分IBM兼容机默认都是关闭的。我猜是因为PC刚启动的时候都运行在16位的实模式下，此时为了保持向前兼容，所以都默认关闭A20，在启动代码中自行开启。