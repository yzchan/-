# 软盘逻辑寻址

CHS寻址 LBA寻址

## 如何根据逻辑扇区号计算出 磁头-柱面-扇区 从而利用int13

1.44m软盘每磁道扇区数18

观察逻辑扇区号跟磁头、柱面、扇区的关系可以看出规律：(给定逻辑扇区号x)
扇区号的计算最简单： 扇区号=(x/18)+1 柱面是从0增长到79： 扇区号每增加36(18*2)，柱面号+1 柱面号 = x/36的商 磁头号是0和1交替出现的： 扇区号每增加18，磁头交换一次(0->1 1->0)
y=x/18的商偶数=0 奇数=1 磁头号 = y & 1

> 可见软盘的排列并不是把一面全部写满再去写另一面，而是交替的。这样安排的好处是：当读写连续的扇区数据时，可以减少磁头的移动次数，提高读写效率。

计算CHS首先需要计算逻辑扇区号x/18，计算柱面则是x/36。用汇编实现除法很不直观，为简单起见，对柱面的计算可以稍微转换一下：x/18是必不可省的，x/36可以利用x/18的商再除2即可（相当于先除18再除），除2可以直接逻辑右移 >>
1，这样可以只用一次div指令即可。

## 代码实现

先看一下int13h 2h号子功能

功能描述：读扇区

入口参数：AH＝02H

AL＝扇区数

CH＝柱面

CL＝扇区

DH＝磁头

DL＝驱动器，00H-7FH：软盘；80H~0FFH：硬盘

ES:BX＝缓冲区的地址

出口参数：CF＝0——操作成功，AH＝00H，AL＝传输的扇区数，否则，AH＝状态代码，参见功能号01H中的说明

虽然功能很简单，但是入参中把ax/bx/cx/dx这4个通用数据寄存器都占用了。所以中间状态只靠寄存器来辗转腾挪会相当麻烦，去栈上开辟一些空间会让逻辑更简洁。